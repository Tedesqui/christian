<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-key="title">IA Crist√£ - Um Di√°logo de F√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #chat-window {
            background-image: linear-gradient(rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.05)), url('images/heaven.jpeg');
            background-size: cover; background-position: center; position: relative; z-index: 40;
        }
        #user-input { caret-color: #2563eb; }
        .hidden { display: none; }
        .mic-wrapper { position: relative; display: inline-flex; align-items: center; justify-content: center; z-index: 50; }
        .recording button { transform: scale(1.5); background-color: #22c55e !important; transition: transform 0.2s ease, background-color 0.2s ease; }
        #payment-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: flex; align-items: center; justify-content: center; }
        #payment-modal { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); max-width: 400px; text-align: center; width: 90%; }
    </style>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen">
    <div class="flex flex-col w-full max-w-3xl h-[85vh] bg-white rounded-2xl shadow-2xl m-4" style="transform: translateY(-10%)">
        <header class="bg-blue-600 text-white p-6 rounded-t-2xl shadow-md flex items-center space-x-4">
            <img src="images/jesus.jpg" alt="Imagem de Jesus Cristo" data-key="header_alt" class="h-20 w-20 rounded-full object-cover border-2 border-white" />
            <div>
                <h1 class="text-2xl font-bold" data-key="header_title">IA Crist√£</h1>
                <p class="text-sm text-white" data-key="header_subtitle">O seu companheiro para reflex√£o e estudo da Palavra.</p>
            </div>
        </header>

        <main id="chat-window" class="flex-1 p-6 overflow-y-auto">
            <div class="message-ai mb-4 flex">
                <div class="bg-slate-200 text-slate-800 rounded-lg rounded-bl-none p-3 max-w-lg">
                    <p class="text-sm" data-key="welcome_message">Paz do Senhor! Eu sou o seu assistente virtual crist√£o. Estou aqui para te ajudar a aprofundar-se na Palavra de Deus. Sinta-se √† vontade para perguntar sobre vers√≠culos, personagens b√≠blicos, ou para conversarmos sobre os desafios da vida sob a √≥tica crist√£.</p>
                </div>
            </div>
        </main>

        <footer class="p-2 bg-white rounded-b-2xl">
            <div class="w-full">
                <div class="flex items-center bg-slate-100 rounded-full p-1.5">
                    <input type="text" id="user-input" placeholder="Fale ou escreva..." data-key="input_placeholder" class="flex-1 bg-transparent border-none focus:ring-0 text-slate-800 placeholder-slate-400 px-4" />
                    <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2.5 transition-colors duration-300 ml-2.5 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                    <div class="mic-wrapper">
                        <button id="mic-button" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2.5 transition-colors duration-300 ml-2.5">
                            <svg xmlns="http://www.w3.org/2000/svg" id="mic-icon" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <div id="payment-modal-overlay" class="hidden">
        <div id="payment-modal">
            <div id="initial-payment-content">
                <h2 class="text-2xl font-bold text-slate-800 mb-2" data-key="payment_title">Acesso Expirado</h2>
                <p class="text-slate-600 mb-6" data-key="payment_description">Para continuar sua jornada de f√©, √© necess√°ria uma pequena cobran√ßa para a manuten√ß√£o do nosso servi√ßo. Assine o acesso semanal.</p>
                <button id="subscribe-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300" data-key="payment_button">Assinar por R$ 14,90 / semana</button>
            </div>

            <div id="pix-email-content" class="hidden w-full">
                 <p class="text-sm text-slate-600 mb-4" data-key="pix_email_info">Para gerar o QR Code, por favor, informe seu e-mail.</p>
                 <form id="pix-form">
                    <input type="email" id="pix-email" placeholder="seuemail@exemplo.com" data-key-placeholder="pix_email_placeholder" required class="w-full text-center p-3 border border-slate-300 rounded-md bg-slate-50 text-slate-800 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <button type="submit" id="generate-pix-btn" class="w-full bg-[#009ee3] hover:bg-[#008ac9] text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300" data-key="pix_generate_button">Gerar PIX</button>
                 </form>
            </div>

            <div id="pix-qr-code-content" class="hidden w-full">
                <p class="font-semibold text-slate-700" data-key="pix_scan_or_copy">Escaneie o QR Code ou use o Copia e Cola:</p>
                <img id="pix-qr-code-image" src="" alt="QR Code PIX" class="mx-auto my-4 border-4 border-slate-200 rounded-lg w-56 h-56">
                <div class="flex">
                    <input type="text" id="pix-copy-paste-code" readonly class="flex-grow min-w-0 p-3 border border-slate-300 bg-slate-100 text-slate-600 text-sm rounded-l-md focus:outline-none">
                    <button type="button" id="copy-pix-btn" class="bg-[#22c55e] hover:bg-[#16a34a] text-white font-bold text-sm py-3 px-4 rounded-r-md transition-colors duration-200" data-key="pix_copy_button">Copiar</button>
                </div>
                <p id="pix-status-text" class="mt-4 text-slate-500 animate-pulse" data-key="pix_waiting_payment">Aguardando pagamento...</p>
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');
        const micWrapper = micButton.parentElement;
        const paymentModalOverlay = document.getElementById('payment-modal-overlay');
        const subscribeButton = document.getElementById('subscribe-button');
        const initialPaymentContent = document.getElementById('initial-payment-content');
        
        const pixEmailContent = document.getElementById('pix-email-content');
        const pixForm = document.getElementById('pix-form');
        const pixEmailInput = document.getElementById('pix-email');
        const generatePixBtn = document.getElementById('generate-pix-btn');
        const pixQrCodeContent = document.getElementById('pix-qr-code-content');
        const pixQrCodeImg = document.getElementById('pix-qr-code-image');
        const pixCopyCodeInput = document.getElementById('pix-copy-paste-code');
        const copyPixButton = document.getElementById('copy-pix-btn');
        const pixStatusText = document.getElementById('pix-status-text');

        const FREE_MESSAGES_LIMIT = 3;
        let userMessageCount = parseInt(localStorage.getItem('userMessageCount') || '0');
        let accessExpiry = parseInt(localStorage.getItem('accessExpiry') || '0');
        let paymentCheckInterval = null;

        const translations = {
            "pt": { "title": "IA Crist√£ - Um Di√°logo de F√©", "header_alt": "Imagem de Jesus Cristo", "header_title": "IA Crist√£", "header_subtitle": "O seu companheiro para reflex√£o e estudo da Palavra.", "welcome_message": "Paz do Senhor! Eu sou o seu assistente virtual crist√£o. Estou aqui para te ajudar a aprofundar-se na Palavra de Deus. Sinta-se √† vontade para perguntar sobre vers√≠culos, personagens b√≠blicos, ou para conversarmos sobre os desafios da vida sob a √≥tica crist√£.", "input_placeholder": "Fale ou escreva...", "listening": "üéôÔ∏è Ouvindo...", "typing_indicator": "A meditar na Palavra", "error_message": "Perd√£o, minha ovelha, ocorreu um erro. Por favor, tente novamente.", "mic_denied": "Permiss√£o para o microfone negada. Ative nas defini√ß√µes do seu navegador.", "mic_error": "Ocorreu um erro no reconhecimento de voz.", "payment_title": "Acesso Expirado", "payment_description": "Para continuar sua jornada de f√©, √© necess√°ria uma pequena cobran√ßa para a manuten√ß√£o do nosso servi√ßo. Assine o acesso semanal.", "payment_button": "Assinar por R$ 14,90 / semana", "payment_required_placeholder": "Assinatura necess√°ria para continuar...", "payment_loading": "Redirecionando...", "payment_success": "Pagamento aprovado! Seu acesso foi restaurado por 7 dias.", "pix_email_info": "Para gerar o QR Code, por favor, informe seu e-mail.", "pix_email_placeholder": "seuemail@exemplo.com", "pix_generate_button": "Gerar PIX", "pix_generating": "Aguarde...", "pix_scan_or_copy": "Escaneie o QR Code ou use o Copia e Cola:", "pix_copy_button": "Copiar", "pix_copied_button": "Copiado!", "pix_waiting_payment": "Aguardando pagamento...", "pix_payment_approved": "Pagamento Aprovado! Liberando seu acesso...", "pix_invalid_email": "Por favor, insira um e-mail v√°lido.", "pix_error_generating": "Erro ao gerar o PIX. Tente novamente.", "storage_error_alert": "Seu acesso foi aprovado, mas o navegador est√° impedindo que ele seja salvo.\n\nIsso pode acontecer se voc√™ estiver na NAVEGA√á√ÉO AN√îNIMA ou se as configura√ß√µes de privacidade estiverem muito restritas.\n\nPor favor, use uma janela normal do navegador ou ajuste as configura√ß√µes de dados de site e atualize a p√°gina." },
            "en": { "title": "Christian AI - A Dialogue of Faith", "header_alt": "Image of Jesus Christ", "header_title": "Christian AI", "header_subtitle": "Your companion for reflection and study of the Word.", "welcome_message": "Peace of the Lord! I am your Christian virtual assistant. I am here to help you delve deeper into the Word of God. Feel free to ask about verses, biblical characters, or to talk about life's challenges from a Christian perspective.", "input_placeholder": "Speak or write...", "listening": "üéôÔ∏è Listening...", "typing_indicator": "Meditating on the Word", "error_message": "Pardon me, my sheep, an error occurred. Please try again.", "mic_denied": "Microphone permission denied. Please enable it in your browser settings.", "mic_error": "An error occurred with voice recognition.", "payment_title": "Access Expired", "payment_description": "To continue your journey of faith, a small charge is required to maintain our service. Subscribe for weekly access.", "payment_button": "Subscribe for $2.99 / week", "payment_required_placeholder": "Subscription required to continue...", "payment_loading": "Redirecting...", "payment_success": "Thank you for your offering! Your access has been restored for 7 days.", "storage_error_alert": "Your access has been approved, but the browser is preventing it from being saved.\n\nThis can happen if you are in INCOGNITO MODE or if privacy settings are too strict.\n\nPlease use a normal browser window or adjust your site data settings and refresh the page." },
            "es": { "title": "IA Cristiana - Un Di√°logo de Fe", "header_alt": "Imagen de Jesucristo", "header_title": "IA Cristiana", "header_subtitle": "Tu compa√±ero para la reflexi√≥n y el estudio de la Palabra.", "welcome_message": "¬°Paz del Se√±or! Soy tu asistente virtual cristiano. Estoy aqu√≠ para ayudarte a profundizar en la Palabra de Dios. No dudes en preguntar sobre vers√≠culos, personajes b√≠blicos, o para conversar sobre los desaf√≠os de la vida desde la √≥ptica cristiana.", "input_placeholder": "Habla o escribe...", "listening": "üéôÔ∏è Escuchando...", "typing_indicator": "Meditando en la Palabra", "error_message": "Perd√≥n, mi oveja, ocurri√≥ un error. Por favor, int√©ntalo de nuevo.", "mic_denied": "Se deneg√≥ el permiso para el micr√≥fono. Por favor, act√≠valo en la configuraci√≥n de tu navegador.", "mic_error": "Ocurri√≥ un error con el reconocimiento de voz.", "payment_title": "Acceso Expirado", "payment_description": "Para continuar tu viaje de fe, se requiere un peque√±o cobro para el mantenimiento de nuestro servicio. Suscr√≠bete para el acceso semanal.", "payment_button": "Suscribir por $2.99 / semana", "payment_required_placeholder": "Se requiere suscripci√≥n para continuar...", "payment_loading": "Redirigiendo...", "payment_success": "¬°Gracias por tu ofrenda! Tu acceso ha sido restaurado por 7 d√≠as.", "storage_error_alert": "Su acceso ha sido aprobado, pero el navegador impide que se guarde.\n\nEsto puede ocurrir si est√° en MODO INC√ìGNITO o si la configuraci√≥n de privacidad es demasiado estricta.\n\nUtilice una ventana normal del navegador o ajuste la configuraci√≥n de datos del sitio y actualice la p√°gina." },
            "it": { "title": "IA Cristiana - Un Dialogo di Fede", "header_alt": "Immagine di Ges√π Cristo", "header_title": "IA Cristiana", "header_subtitle": "Il tuo compagno per la riflessione e lo studio della Parola.", "welcome_message": "Pace del Signore! Sono il tuo assistente virtuale cristiano. Sono qui per aiutarti ad approfondire la Parola di Dio. Sentiti libero di chiedere versetti, personaggi biblici o di parlare delle sfide della vita da una prospettiva cristiana.", "input_placeholder": "Parla o scrivi...", "listening": "üéôÔ∏è In ascolto...", "typing_indicator": "Meditando sulla Parola", "error_message": "Perdona, mia pecora, si √® verificato un errore. Per favore, riprova.", "mic_denied": "Permesso per il microfono negato. Abilitalo nelle impostazioni del browser.", "mic_error": "Si √® verificato un errore con il riconoscimento vocale.", "payment_title": "Accesso Scaduto", "payment_description": "Per continuare il tuo cammino di fede, √® richiesto un piccolo contributo per mantenere il nostro servizio. Abbonati per l'accesso settimanale.", "payment_button": "Abbonati per 2,99 ‚Ç¨ / settimana", "payment_required_placeholder": "Abbonamento richiesto per continuare...", "payment_loading": "Reindirizzamento...", "payment_success": "Grazie per la tua offerta! Il tuo accesso √® stato ripristinato per 7 giorni.", "storage_error_alert": "Il tuo accesso √® stato approvato, ma il browser ne impedisce il salvataggio.\n\nCi√≤ pu√≤ accadere se sei in MODALIT√Ä INCOGNITO o se le impostazioni sulla privacy sono troppo restrittive.\n\nUtilizza una normale finestra del browser o modifica le impostazioni dei dati del sito e aggiorna la pagina." },
            "fr": { "title": "IA Chr√©tienne - Un Dialogue de Foi", "header_alt": "Image de J√©sus-Christ", "header_title": "IA Chr√©tienne", "header_subtitle": "Votre compagnon pour la r√©flexion et l'√©tude de la Parole.", "welcome_message": "Paix du Seigneur ! Je suis votre assistant virtuel chr√©tien. Je suis ici pour vous aider √† approfondir la Parole de Dieu. N'h√©sitez pas √† poser des questions sur des versets, des personnages bibliques, ou √† parler des d√©fis de la vie d'un point de vue chr√©tien.", "input_placeholder": "Parlez ou √©crivez...", "listening": "üéôÔ∏è √âcoute...", "typing_indicator": "M√©ditation sur la Parole", "error_message": "Pardon, mon mouton, une erreur est survenue. Veuillez r√©essayer.", "mic_denied": "Permission du microphone refus√©e. Veuillez l'activer dans les param√®tres de votre navigateur.", "mic_error": "Une erreur est survenue avec la reconnaissance vocale.", "payment_title": "Acc√®s Expir√©", "payment_description": "Pour continuer votre chemin de foi, une petite charge est requise pour maintenir notre service. Abonnez-vous pour un acc√®s hebdomadaire.", "payment_button": "S'abonner pour 2,99 ‚Ç¨ / semaine", "payment_required_placeholder": "Abonnement requis pour continuer...", "payment_loading": "Redirection...", "payment_success": "Merci pour votre offrande ! Votre acc√®s a √©t√© restaur√© pour 7 jours.", "storage_error_alert": "Votre acc√®s a √©t√© approuv√©, mais le navigateur en emp√™che l'enregistrement.\n\nCela peut se produire si vous √™tes en MODE INCOGNITO ou si les param√®tres de confidentialit√© sont trop stricts.\n\nVeuillez utiliser une fen√™tre de navigateur normale ou ajuster les param√®tres de donn√©es de votre site et actualiser la page." },
            "de": { "title": "Christliche KI - Ein Dialog des Glaubens", "header_alt": "Bild von Jesus Christus", "header_title": "Christliche KI", "header_subtitle": "Ihr Begleiter zur Besinnung und zum Studium des Wortes.", "welcome_message": "Friede des Herrn! Ich bin Ihr christlicher virtueller Assistent. Ich bin hier, um Ihnen zu helfen, tiefer in das Wort Gottes einzutauchen. Fragen Sie gerne nach Versen, biblischen Charakteren oder sprechen Sie √ºber die Herausforderungen des Lebens aus christlicher Sicht.", "input_placeholder": "Sprechen oder schreiben Sie...", "listening": "üéôÔ∏è H√∂re zu...", "typing_indicator": "Meditiere √ºber das Wort", "error_message": "Verzeihung, mein Schaf, ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.", "mic_denied": "Mikrofonberechtigung verweigert. Bitte aktivieren Sie sie in Ihren Browsereinstellungen.", "mic_error": "Ein Fehler bei der Spracherkennung ist aufgetreten.", "payment_title": "Zugang Abgelaufen", "payment_description": "Um Ihre Glaubensreise fortzusetzen, ist eine kleine Geb√ºhr zur Aufrechterhaltung unseres Dienstes erforderlich. Abonnieren Sie den w√∂chentlichen Zugang.", "payment_button": "Abonnieren f√ºr 2,99 ‚Ç¨ / Woche", "payment_required_placeholder": "Abonnement zum Fortfahren erforderlich...", "payment_loading": "Weiterleitung...", "payment_success": "Danke f√ºr Ihr Opfer! Ihr Zugang wurde f√ºr 7 Tage wiederhergestellt.", "storage_error_alert": "Ihr Zugang wurde genehmigt, aber der Browser verhindert das Speichern.\n\nDies kann passieren, wenn Sie sich im INKOGNITO-MODUS befinden oder die Datenschutzeinstellungen zu streng sind.\n\nBitte verwenden Sie ein normales Browserfenster oder passen Sie Ihre Website-Dateneinstellungen an und aktualisieren Sie die Seite." }
        };
        
        let currentLang = 'pt';

        function getSessionId() { let sid = localStorage.getItem("ia_crista_session_id"); if (!sid || sid.length < 10) { sid = crypto.randomUUID(); localStorage.setItem("ia_crista_session_id", sid); } return sid; }
        function hasActiveAccess() { return Date.now() < accessExpiry; }
        function checkAccess() { if (hasActiveAccess() || userMessageCount < FREE_MESSAGES_LIMIT) { userInput.disabled = false; paymentModalOverlay.classList.add('hidden'); userInput.placeholder = translations[currentLang].input_placeholder; } else { userInput.disabled = true; userInput.placeholder = translations[currentLang].payment_required_placeholder; paymentModalOverlay.classList.remove('hidden'); } }

        function grantAccessAndNotify() {
            try {
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                const newExpiry = Date.now() + sevenDays;
                
                localStorage.setItem('accessExpiry', newExpiry.toString());
                localStorage.removeItem('userMessageCount');
                
                accessExpiry = newExpiry;
                userMessageCount = 0;
                
                paymentModalOverlay.classList.add('hidden');
                appendMessage(translations[currentLang].payment_success, 'system');
                checkAccess();
            } catch (error) {
                console.error("Erro ao salvar o acesso no localStorage:", error);
                alert(translations[currentLang].storage_error_alert);
                paymentModalOverlay.classList.add('hidden');
                checkAccess();
            }
        }

        function startPollingPaymentStatus(sessionId) {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            paymentCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check-payment-status?sessionId=${sessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.paid) {
                            clearInterval(paymentCheckInterval);
                            pixStatusText.textContent = translations[currentLang].pix_payment_approved;
                            setTimeout(grantAccessAndNotify, 1500);
                        }
                    }
                } catch (error) { console.error("Erro ao verificar status:", error); }
            }, 4000);
        }

        subscribeButton.addEventListener('click', () => {
            const userFullLanguage = (navigator.language || navigator.userLanguage).toLowerCase();
            if (userFullLanguage.startsWith('pt')) {
                initialPaymentContent.classList.add('hidden');
                pixEmailContent.classList.remove('hidden');
            } else {
                subscribeButton.disabled = true;
                subscribeButton.textContent = translations[currentLang].payment_loading;
                fetch('/api/create-checkout-session', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ langCode: currentLang }), })
                .then(res => res.json())
                .then(({ checkoutUrl }) => { window.location.href = checkoutUrl; })
                .catch(error => { console.error("Stripe Error:", error); subscribeButton.disabled = false; subscribeButton.textContent = translations[currentLang].payment_button; });
            }
        });

        pixForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = pixEmailInput.value;
            if (!/^\S+@\S+\.\S+$/.test(email)) { alert(translations[currentLang].pix_invalid_email); return; }
            generatePixBtn.disabled = true;
            generatePixBtn.textContent = translations[currentLang].pix_generating;
            try {
                const response = await fetch('/api/create-pix-payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId: getSessionId(), email: email }), });
                const data = await response.json();
                if (!response.ok) { throw new Error(data.details || 'API Error'); }
                pixQrCodeImg.src = `data:image/jpeg;base64,${data.qrCodeBase64}`;
                pixCopyCodeInput.value = data.qrCode;
                pixEmailContent.classList.add('hidden');
                pixQrCodeContent.classList.remove('hidden');
                startPollingPaymentStatus(getSessionId());
            } catch (error) { alert(translations[currentLang].pix_error_generating); console.error("Erro ao gerar PIX:", error); generatePixBtn.disabled = false; generatePixBtn.textContent = translations[currentLang].pix_generate_button; }
        });

        copyPixButton.addEventListener('click', () => { pixCopyCodeInput.select(); document.execCommand('copy'); copyPixButton.textContent = translations[currentLang].pix_copied_button; setTimeout(() => { copyPixButton.textContent = translations[currentLang].pix_copy_button; }, 2000); });
        
        function setLanguage(lang) {
            const langCode = (lang || 'pt').split('-')[0];
            currentLang = translations[langCode] ? langCode : 'pt';
            document.documentElement.lang = currentLang;
            document.querySelectorAll('[data-key]').forEach(element => { const key = element.getAttribute('data-key'); if (translations[currentLang][key]) { if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') { element.placeholder = translations[currentLang][key]; } else if (element.tagName === 'IMG') { element.alt = translations[currentLang][key]; } else { element.textContent = translations[currentLang][key]; } } });
            document.querySelectorAll('[data-key-placeholder]').forEach(el => { const key = el.getAttribute('data-key-placeholder'); if (translations[currentLang][key]) el.placeholder = translations[currentLang][key]; });
            checkAccess();
        }
        userInput.addEventListener('input', () => { if (userInput.value.trim() !== '') { sendButton.classList.remove('hidden'); micWrapper.classList.add('hidden'); } else { sendButton.classList.add('hidden'); micWrapper.classList.remove('hidden'); } });
        async function sendMessage(directMessage = null) {
            checkAccess();
            if (userInput.disabled) return;
            const message = directMessage || userInput.value.trim();
            if (!message) return;
            if (!hasActiveAccess()) { userMessageCount++; localStorage.setItem('userMessageCount', userMessageCount.toString()); }
            appendMessage(message, 'user');
            if (directMessage === null) { userInput.value = ''; userInput.dispatchEvent(new Event('input')); }
            showTypingIndicator();
            try {
                const response = await fetch('/api/ask-christian-ai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: message, language: currentLang }), });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`Erro no servidor: ${response.status} - ${errorData.error}`); }
                const data = await response.json();
                removeTypingIndicator();
                appendMessage(data.answer, 'ai');
            } catch (error) { console.error('Erro ao comunicar com o backend:', error); removeTypingIndicator(); appendMessage(translations[currentLang].error_message, 'ai'); } finally { checkAccess(); }
        }
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.interimResults = false;
            micButton.addEventListener('mousedown', () => { if (userInput.disabled) return; recognition.lang = currentLang === 'en' ? 'en-US' : `${currentLang}-${currentLang.toUpperCase()}`; micWrapper.classList.add('recording'); recognition.start(); appendMessage(translations[currentLang].listening, 'system'); });
            micButton.addEventListener('mouseup', () => { micWrapper.classList.remove('recording'); recognition.stop(); removeSystemMessage(); });
            micButton.addEventListener('touchstart', (e) => { e.preventDefault(); micButton.dispatchEvent(new Event('mousedown')); });
            micButton.addEventListener('touchend', (e) => { e.preventDefault(); micButton.dispatchEvent(new Event('mouseup')); });
            recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; if (transcript) sendMessage(transcript); };
            recognition.onerror = (event) => { let msg = translations[currentLang].mic_error; if (event.error === 'not-allowed') { msg = translations[currentLang].mic_denied; } removeSystemMessage(); appendMessage(msg, 'system-error'); };
            recognition.onspeechend = () => { recognition.stop(); removeSystemMessage(); };
        } else { micWrapper.style.display = 'none'; }
        function appendMessage(message, sender) { const messageWrapper = document.createElement('div'); const messageBubble = document.createElement('div'); if (sender === 'user') { messageWrapper.className = 'message-user mb-4 flex justify-end'; messageBubble.className = 'bg-blue-600 text-white rounded-lg rounded-br-none p-3 max-w-lg'; } else if (sender === 'ai') { messageWrapper.className = 'message-ai mb-4 flex'; messageBubble.className = 'bg-slate-200 text-slate-800 rounded-lg rounded-bl-none p-3 max-w-lg'; } else { const existing = document.getElementById('system-message'); if (existing) existing.remove(); messageWrapper.id = 'system-message'; messageWrapper.className = 'message-system mb-4 flex justify-center'; messageBubble.className = sender === 'system-error' ? 'bg-red-100 text-red-700 rounded-lg p-2 text-xs' : 'bg-yellow-100 text-yellow-700 rounded-lg p-2 text-xs'; } messageBubble.innerHTML = `<p class="text-sm">${message.replace(/\n/g, '<br>')}</p>`; messageWrapper.appendChild(messageBubble); chatWindow.appendChild(messageWrapper); chatWindow.scrollTop = chatWindow.scrollHeight; }
        function removeSystemMessage() { const el = document.getElementById('system-message'); if (el) el.remove(); }
        function showTypingIndicator() { const ind = `<div id="typing-indicator" class="message-ai mb-4 flex"><div class="bg-slate-200 text-slate-800 rounded-lg rounded-bl-none p-3 max-w-lg"><div class="flex items-center space-x-1"><span class="text-sm">${translations[currentLang].typing_indicator}</span><div class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div><div class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div><div class="h-2 w-2 bg-slate-400 rounded-full animate-bounce"></div></div></div></div>`; chatWindow.insertAdjacentHTML('beforeend', ind); chatWindow.scrollTop = chatWindow.scrollHeight; }
        function removeTypingIndicator() { const el = document.getElementById('typing-indicator'); if (el) el.remove(); }
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('session_id')) { grantAccessAndNotify(); window.history.replaceState(null, '', window.location.pathname); }
            const userLang = navigator.language || navigator.userLanguage;
            setLanguage(userLang.startsWith('pt') ? 'pt' : userLang);
            userInput.focus();
        });
    </script>
</body>

</html>
