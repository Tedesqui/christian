<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-key="payment_title">Acesso à IA Cristã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #payment-modal { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); max-width: 400px; text-align: center; width: 90%; }
        .hidden { display: none; }
    </style>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen">
    
    <script>
        (() => {
            const token = localStorage.getItem('iaCristaAccessToken');
            if (token) {
                try {
                    const { expiry } = JSON.parse(token);
                    if (Date.now() < expiry) {
                        window.location.href = '/chat.html'; // Redireciona se já tiver acesso
                    }
                } catch (e) {
                    localStorage.removeItem('iaCristaAccessToken');
                }
            }
        })();
    </script>

    <div id="payment-modal">
        <div id="initial-payment-content">
            <h2 class="text-2xl font-bold text-slate-800 mb-2" data-key="payment_title">Acesso Expirado</h2>
            <p class="text-slate-600 mb-6" data-key="payment_description">Para conversar com a IA Cristã, é necessária uma pequena contribuição para a manutenção do serviço. Assine o acesso semanal.</p>
            <button id="subscribe-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300" data-key="payment_button">Assinar por R$ 14,90 / semana</button>
        </div>

        <div id="pix-email-content" class="hidden w-full">
             <p class="text-sm text-slate-600 mb-4" data-key="pix_email_info">Para gerar o QR Code, por favor, informe seu e-mail.</p>
             <form id="pix-form">
                <input type="email" id="pix-email" placeholder="seuemail@exemplo.com" data-key-placeholder="pix_email_placeholder" required class="w-full text-center p-3 border border-slate-300 rounded-md bg-slate-50 text-slate-800 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button type="submit" id="generate-pix-btn" class="w-full bg-[#009ee3] hover:bg-[#008ac9] text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300" data-key="pix_generate_button">Gerar PIX</button>
             </form>
        </div>

        <div id="pix-qr-code-content" class="hidden w-full">
            <p class="font-semibold text-slate-700" data-key="pix_scan_or_copy">Escaneie o QR Code ou use o Copia e Cola:</p>
            <img id="pix-qr-code-image" src="" alt="QR Code PIX" class="mx-auto my-4 border-4 border-slate-200 rounded-lg w-56 h-56">
            <div class="flex">
                <input type="text" id="pix-copy-paste-code" readonly class="flex-grow min-w-0 p-3 border border-slate-300 bg-slate-100 text-slate-600 text-sm rounded-l-md focus:outline-none">
                <button type="button" id="copy-pix-btn" class="bg-[#22c55e] hover:bg-[#16a34a] text-white font-bold text-sm py-3 px-4 rounded-r-md transition-colors duration-200" data-key="pix_copy_button">Copiar</button>
            </div>
            <p id="pix-status-text" class="mt-4 text-slate-500 animate-pulse" data-key="pix_waiting_payment">Aguardando pagamento...</p>
        </div>
    </div>

    <script>
        const subscribeButton = document.getElementById('subscribe-button');
        const initialPaymentContent = document.getElementById('initial-payment-content');
        const pixEmailContent = document.getElementById('pix-email-content');
        const pixForm = document.getElementById('pix-form');
        const pixEmailInput = document.getElementById('pix-email');
        const generatePixBtn = document.getElementById('generate-pix-btn');
        const pixQrCodeContent = document.getElementById('pix-qr-code-content');
        const pixQrCodeImg = document.getElementById('pix-qr-code-image');
        const pixCopyCodeInput = document.getElementById('pix-copy-paste-code');
        const copyPixButton = document.getElementById('copy-pix-btn');
        const pixStatusText = document.getElementById('pix-status-text');
        
        let paymentCheckInterval = null;

        const translations = {
            "pt": { "payment_title": "Acesso à IA Cristã", "payment_description": "Para conversar com a IA Cristã, é necessária uma pequena contribuição para a manutenção do serviço. Assine o acesso semanal.", "payment_button": "Assinar por R$ 14,90 / semana", "payment_loading": "Redirecionando...", "pix_email_info": "Para gerar o QR Code, por favor, informe seu e-mail.", "pix_email_placeholder": "seuemail@exemplo.com", "pix_generate_button": "Gerar PIX", "pix_generating": "Aguarde...", "pix_scan_or_copy": "Escaneie o QR Code ou use o Copia e Cola:", "pix_copy_button": "Copiar", "pix_copied_button": "Copiado!", "pix_waiting_payment": "Aguardando pagamento...", "pix_payment_approved": "Pagamento Aprovado! Redirecionando...", "pix_invalid_email": "Por favor, insira um e-mail válido.", "pix_error_generating": "Erro ao gerar o PIX. Tente novamente." },
            "en": { "payment_title": "Access Christian AI", "payment_description": "To chat with Christian AI, a small contribution is required for service maintenance. Subscribe for weekly access.", "payment_button": "Subscribe for $2.99 / week", "payment_loading": "Redirecting..." },
            "es": { "payment_title": "Acceso a IA Cristiana", "payment_description": "Para chatear con IA Cristiana, se requiere una pequeña contribución para el mantenimiento del servicio. Suscríbete para acceso semanal.", "payment_button": "Suscribir por $2.99 / semana", "payment_loading": "Redirigiendo..." },
            "it": { "payment_title": "Accesso a IA Cristiana", "payment_description": "Per chattare con l'IA Cristiana, è richiesto un piccolo contributo per la manutenzione del servizio. Abbonati per l'accesso settimanale.", "payment_button": "Abbonati per 2,99 € / settimana", "payment_loading": "Reindirizzamento..." },
            "fr": { "payment_title": "Accès à l'IA Chrétienne", "payment_description": "Pour discuter avec l'IA Chrétienne, une petite contribution est requise pour la maintenance du service. Abonnez-vous pour un accès hebdomadaire.", "payment_button": "S'abonner pour 2,99 € / semaine", "payment_loading": "Redirection..." },
            "de": { "payment_title": "Zugang zur Christlichen KI", "payment_description": "Um mit der Christlichen KI zu chatten, ist ein kleiner Beitrag zur Wartung des Dienstes erforderlich. Abonnieren Sie den wöchentlichen Zugang.", "payment_button": "Abonnieren für 2,99 € / Woche", "payment_loading": "Weiterleitung..." }
        };
        let currentLang = 'pt';

        function getSessionId() {
            let sid = localStorage.getItem("ia_crista_session_id");
            if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("ia_crista_session_id", sid); }
            return sid;
        }

        function grantAccessAndNotify() {
            try {
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                const newExpiry = Date.now() + sevenDays;
                
                const token = JSON.stringify({ expiry: newExpiry });
                localStorage.setItem('iaCristaAccessToken', token);
                
                window.location.href = '/chat.html'; // Redireciona para o chat
            } catch (error) {
                console.error("Erro ao salvar o acesso:", error);
                alert("Ocorreu um erro ao salvar seu acesso. Verifique as configurações de privacidade do seu navegador e tente novamente.");
            }
        }

        function startPollingPaymentStatus(sessionId) {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            paymentCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check-payment-status?sessionId=${sessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.paid) {
                            clearInterval(paymentCheckInterval);
                            pixStatusText.textContent = (translations[currentLang] || translations['pt']).pix_payment_approved;
                            setTimeout(grantAccessAndNotify, 1500);
                        }
                    }
                } catch (error) { console.error("Erro ao verificar status:", error); }
            }, 4000);
        }

        subscribeButton.addEventListener('click', () => {
            const userFullLanguage = (navigator.language || navigator.userLanguage).toLowerCase();
            // *** LÓGICA CORRIGIDA PARA USAR 'pt-BR' ***
            if (userFullLanguage === 'pt-br') {
                initialPaymentContent.classList.add('hidden');
                pixEmailContent.classList.remove('hidden');
            } else {
                subscribeButton.disabled = true;
                subscribeButton.textContent = (translations[currentLang] || translations['en']).payment_loading;
                fetch('/api/create-checkout-session', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ langCode: currentLang }), })
                .then(res => res.json())
                .then(({ checkoutUrl }) => { window.location.href = checkoutUrl; })
                .catch(error => { console.error("Stripe Error:", error); subscribeButton.disabled = false; subscribeButton.textContent = (translations[currentLang] || translations['en']).payment_button; });
            }
        });

        pixForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = pixEmailInput.value;
            if (!/^\S+@\S+\.\S+$/.test(email)) { alert((translations[currentLang] || translations['pt']).pix_invalid_email); return; }
            generatePixBtn.disabled = true;
            generatePixBtn.textContent = (translations[currentLang] || translations['pt']).pix_generating;
            try {
                const response = await fetch('/api/create-pix-payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId: getSessionId(), email: email }), });
                const data = await response.json();
                if (!response.ok) { throw new Error(data.details || 'API Error'); }
                pixQrCodeImg.src = `data:image/jpeg;base64,${data.qrCodeBase64}`;
                pixCopyCodeInput.value = data.qrCode;
                pixEmailContent.classList.add('hidden');
                pixQrCodeContent.classList.remove('hidden');
                startPollingPaymentStatus(getSessionId());
            } catch (error) { alert((translations[currentLang] || translations['pt']).pix_error_generating); console.error("Erro ao gerar PIX:", error); generatePixBtn.disabled = false; generatePixBtn.textContent = (translations[currentLang] || translations['pt']).pix_generate_button; }
        });

        copyPixButton.addEventListener('click', () => { pixCopyCodeInput.select(); document.execCommand('copy'); copyPixButton.textContent = (translations[currentLang] || translations['pt']).pix_copied_button; setTimeout(() => { copyPixButton.textContent = (translations[currentLang] || translations['pt']).pix_copy_button; }, 2000); });
        
        window.addEventListener('load', () => {
            const userLang = (navigator.language || navigator.userLanguage).toLowerCase();
            const langCode = userLang.split('-')[0];
            currentLang = translations[langCode] ? langCode : 'en';
            
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                const dict = translations[currentLang] || translations['en'];
                if (dict[key]) {
                    element.textContent = dict[key];
                }
            });
             document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-key-placeholder');
                 const dict = translations[currentLang] || translations['en'];
                 if (dict[key]) {
                    el.placeholder = dict[key];
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('session_id')) {
                grantAccessAndNotify(); 
            }
        });
    </script>
</body>
</html>
