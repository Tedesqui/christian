<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-key="payment_title">Acesso à IA Cristã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
    </style>
</head>

<body class="bg-blue-100 flex items-center justify-center min-h-screen text-slate-800">
    
    <script>
        (() => {
            const token = localStorage.getItem('iaCristaAccessToken');
            if (token) {
                try {
                    const { expiry } = JSON.parse(token);
                    if (Date.now() < expiry) {
                        window.location.href = '/chat.html';
                    }
                } catch (e) {
                    localStorage.removeItem('iaCristaAccessToken');
                }
            }
        })();
    </script>

    <div id="payment-view" class="text-center p-8 max-w-md w-full bg-white rounded-2xl shadow-lg" style="transform: translateY(-60px);">
        <div id="initial-payment-content">
            <h1 class="text-4xl font-bold mb-4 text-blue-600 pt-4" data-key="payment_title">Acesso à IA Cristã</h1>
            <p class="text-lg text-slate-600 mb-8" data-key="payment_description">Para conversar com a IA Cristã, é necessária uma pequena contribuição para a manutenção do serviço.</p>
            <div class="bg-blue-50 p-6 rounded-lg mb-8">
                <p class="text-xl">Acesso Semanal</p>
                <p id="price-display" class="text-5xl font-bold my-2 text-blue-700">R$ 14,90</p>
            </div>
            <button id="subscribe-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg py-4 px-8 rounded-full transition-transform transform hover:scale-105 duration-300" data-key="payment_button">
                Assinar Agora
            </button>
        </div>

        <div id="pix-email-content" class="hidden w-full">
             <p class="text-lg text-slate-600 mb-4" data-key="pix_email_info">Para gerar o PIX, por favor, informe seu e-mail.</p>
             <form id="pix-form">
                <input type="email" id="pix-email" placeholder="seuemail@exemplo.com" data-key-placeholder="pix_email_placeholder" required class="w-full text-center p-3 border border-slate-300 rounded-md bg-slate-50 text-slate-800 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button type="submit" id="generate-pix-btn" class="w-full bg-[#009ee3] hover:bg-[#008ac9] text-white font-bold text-lg py-4 px-8 rounded-full transition-transform transform hover:scale-105 duration-300" data-key="pix_generate_button">Gerar QR Code PIX</button>
             </form>
        </div>

        <div id="pix-qr-code-content" class="hidden w-full">
            <p class="text-lg font-semibold text-slate-700" data-key="pix_scan_or_copy">Escaneie o QR Code ou use o Copia e Cola:</p>
            <img id="pix-qr-code-image" src="" alt="QR Code PIX" class="mx-auto my-4 border-4 border-slate-200 rounded-lg w-56 h-56">
            <div class="flex">
                <input type="text" id="pix-copy-paste-code" readonly class="flex-grow min-w-0 p-3 border border-slate-300 bg-slate-100 text-slate-600 text-sm rounded-l-md focus:outline-none">
                <button type="button" id="copy-pix-btn" class="bg-[#22c55e] hover:bg-[#16a34a] text-white font-bold text-sm py-3 px-4 rounded-r-md transition-colors duration-200" data-key="pix_copy_button">Copiar</button>
            </div>
            <p id="pix-status-text" class="mt-4 text-slate-500 animate-pulse" data-key="pix_waiting_payment">Aguardando pagamento...</p>
        </div>
    </div>

    <script>
        const subscribeButton = document.getElementById('subscribe-button');
        const initialPaymentContent = document.getElementById('initial-payment-content');
        const pixEmailContent = document.getElementById('pix-email-content');
        const pixForm = document.getElementById('pix-form');
        const pixEmailInput = document.getElementById('pix-email');
        const generatePixBtn = document.getElementById('generate-pix-btn');
        const pixQrCodeContent = document.getElementById('pix-qr-code-content');
        const pixQrCodeImg = document.getElementById('pix-qr-code-image');
        const pixCopyCodeInput = document.getElementById('pix-copy-paste-code');
        const copyPixButton = document.getElementById('copy-pix-btn');
        const pixStatusText = document.getElementById('pix-status-text');
        
        let paymentCheckInterval = null;

        const translations = {
            "pt": { "payment_title": "Acesso à IA Cristã", "payment_description": "Para conversar com a IA Cristã, é necessária uma pequena contribuição para a manutenção do serviço.", "payment_button": "Assinar Agora", "price_display": "R$ 14,90", "payment_loading": "Redirecionando...", "pix_email_info": "Para gerar o PIX, por favor, informe seu e-mail.", "pix_email_placeholder": "seuemail@exemplo.com", "pix_generate_button": "Gerar QR Code PIX", "pix_generating": "Aguarde...", "pix_scan_or_copy": "Escaneie o QR Code ou use o Copia e Cola:", "pix_copy_button": "Copiar", "pix_copied_button": "Copiado!", "pix_waiting_payment": "Aguardando pagamento...", "pix_payment_approved": "Pagamento Aprovado! Redirecionando...", "pix_invalid_email": "Por favor, insira um e-mail válido.", "pix_error_generating": "Erro ao gerar o PIX. Tente novamente." },
            "en": { "payment_title": "Access Christian AI", "payment_description": "To chat with Christian AI, a small contribution is required for service maintenance.", "payment_button": "Subscribe Now", "price_display": "$2.99 USD", "payment_loading": "Redirecting..." },
            "es": { "payment_title": "Acceso a IA Cristiana", "payment_description": "Para chatear con IA Cristiana, se requiere una pequeña contribución para el mantenimiento del servicio.", "payment_button": "Suscribir Ahora", "price_display": "$2.99 USD", "payment_loading": "Redirigiendo..." },
            "it": { "payment_title": "Accesso a IA Cristiana", "payment_description": "Per chattare con l'IA Cristiana, è richiesto un piccolo contributo per la manutenzione del servizio.", "payment_button": "Abbonati Ora", "price_display": "€2.99 EUR", "payment_loading": "Reindirizzamento..." },
            "fr": { "payment_title": "Accès à l'IA Chrétienne", "payment_description": "Pour discuter avec l'IA Chrétienne, une petite contribution est requise pour la maintenance du service.", "payment_button": "S'abonner Maintenant", "price_display": "€2.99 EUR", "payment_loading": "Redirection..." },
            "de": { "payment_title": "Zugang zur Christlichen KI", "payment_description": "Um mit der Christlichen KI zu chatten, ist ein kleiner Beitrag zur Wartung des Dienstes erforderlich.", "payment_button": "Jetzt abonnieren", "price_display": "€2.99 EUR", "payment_loading": "Weiterleitung..." },
            "ru": { "payment_title": "Доступ к Христианскому ИИ", "payment_description": "Чтобы общаться с Христианским ИИ, требуется небольшой взнос на обслуживание сервиса.", "payment_button": "Подписаться сейчас", "price_display": "$2.99 USD", "payment_loading": "Перенаправление..." },
            "ja": { "payment_title": "キリスト教AIへのアクセス", "payment_description": "キリスト教AIとチャットするには、サービスの維持のために少額の寄付が必要です。", "payment_button": "今すぐ登録", "price_display": "$2.99 USD", "payment_loading": "リダイレクト中..." },
            "ko": { "payment_title": "기독교 AI 액세스", "payment_description": "기독교 AI와 채팅하려면 서비스 유지를 위해 약간의 기여가 필요합니다.", "payment_button": "지금 구독", "price_display": "$2.99 USD", "payment_loading": "리디렉션 중..." },
            "zh": { "payment_title": "访问基督教AI", "payment_description": "与基督教AI聊天需要为服务维护提供少量捐款。", "payment_button": "立即订阅", "price_display": "$2.99 USD", "payment_loading": "正在重定向..." },
            "hi": { "payment_title": "ईसाई एआई तक पहुंच", "payment_description": "ईसाई एआई के साथ चैट करने के लिए, सेवा रखरखाव के लिए एक छोटे से योगदान की आवश्यकता है।", "payment_button": "अभी सदस्यता लें", "price_display": "$2.99 USD", "payment_loading": "पुनर्निर्देशित कर रहा है..." },
            "fil": { "payment_title": "Access sa Christian AI", "payment_description": "Upang makipag-chat sa Christian AI, kailangan ng maliit na kontribusyon para sa pagpapanatili ng serbisyo.", "payment_button": "Mag-subscribe Ngayon", "price_display": "$2.99 USD", "payment_loading": "Nagre-redirect..." },
            "sv": { "payment_title": "Tillgång till Kristen AI", "payment_description": "För att chatta med Kristen AI krävs ett litet bidrag för underhåll av tjänsten.", "payment_button": "Prenumerera nu", "price_display": "$2.99 USD", "payment_loading": "Omdirigerar..." },
            "pl": { "payment_title": "Dostęp do Chrześcijańskiej SI", "payment_description": "Aby rozmawiać z Chrześcijańską SI, wymagana jest niewielka opłata na utrzymanie usługi.", "payment_button": "Subskrybuj teraz", "price_display": "$2.99 USD", "payment_loading": "Przekierowywanie..." },
            "bn": { "payment_title": "খ্রিস্টান এআই-তে অ্যাক্সেস", "payment_description": "খ্রিস্টান এআই-এর সাথে চ্যাট করার জন্য, পরিষেবা রক্ষণাবেক্ষণের জন্য একটি ছোট অবদান প্রয়োজন।", "payment_button": "এখন সাবস্ক্রাইব করুন", "price_display": "$2.99 USD", "payment_loading": "পুনঃনির্দেশ করা হচ্ছে..." },
            "ar": { "payment_title": "الوصول إلى الذكاء الاصطناعي المسيحي", "payment_description": "للدردشة مع الذكاء الاصطناعي المسيحي، مطلوب مساهمة صغيرة لصيانة الخدمة.", "payment_button": "اشترك الآن", "price_display": "$2.99 USD", "payment_loading": "إعادة توجيه..." }
        };

        let currentLang = 'pt';

        function getSessionId() {
            let sid = localStorage.getItem("ia_crista_session_id");
            if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("ia_crista_session_id", sid); }
            return sid;
        }

        function grantAccessAndNotify() {
            try {
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                const newExpiry = Date.now() + sevenDays;
                
                const token = JSON.stringify({ expiry: newExpiry });
                localStorage.setItem('iaCristaAccessToken', token);
                
                window.location.href = '/chat.html';
            } catch (error) {
                console.error("Erro ao salvar o acesso:", error);
                alert("Ocorreu um erro ao salvar seu acesso. Verifique as configurações de privacidade do seu navegador e tente novamente.");
            }
        }

        function startPollingPaymentStatus(sessionId) {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            paymentCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check-payment-status?sessionId=${sessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.paid) {
                            clearInterval(paymentCheckInterval);
                            pixStatusText.textContent = (translations[currentLang] || translations['pt']).pix_payment_approved;
                            setTimeout(grantAccessAndNotify, 1500);
                        }
                    }
                } catch (error) { console.error("Erro ao verificar status:", error); }
            }, 4000);
        }

        subscribeButton.addEventListener('click', () => {
            const userFullLanguage = (navigator.language || navigator.userLanguage).toLowerCase();
            if (userFullLanguage === 'pt-br') {
                initialPaymentContent.classList.add('hidden');
                pixEmailContent.classList.remove('hidden');
            } else {
                subscribeButton.disabled = true;
                subscribeButton.textContent = (translations[currentLang] || translations['en']).payment_loading;
                fetch('/api/create-checkout-session', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ langCode: currentLang }), })
                .then(res => res.json())
                .then(({ checkoutUrl }) => { window.location.href = checkoutUrl; })
                .catch(error => { console.error("Stripe Error:", error); subscribeButton.disabled = false; subscribeButton.textContent = (translations[currentLang] || translations['en']).payment_button; });
            }
        });

        pixForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = pixEmailInput.value;
            if (!/^\S+@\S+\.\S+$/.test(email)) { alert((translations[currentLang] || translations['pt']).pix_invalid_email); return; }
            generatePixBtn.disabled = true;
            generatePixBtn.textContent = (translations[currentLang] || translations['pt']).pix_generating;
            try {
                const response = await fetch('/api/create-pix-payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId: getSessionId(), email: email }), });
                const data = await response.json();
                if (!response.ok) { throw new Error(data.details || 'API Error'); }
                pixQrCodeImg.src = `data:image/jpeg;base64,${data.qrCodeBase64}`;
                pixCopyCodeInput.value = data.qrCode;
                pixEmailContent.classList.add('hidden');
                pixQrCodeContent.classList.remove('hidden');
                startPollingPaymentStatus(getSessionId());
            } catch (error) { alert((translations[currentLang] || translations['pt']).pix_error_generating); console.error("Erro ao gerar PIX:", error); generatePixBtn.disabled = false; generatePixBtn.textContent = (translations[currentLang] || translations['pt']).pix_generate_button; }
        });

        copyPixButton.addEventListener('click', () => { pixCopyCodeInput.select(); document.execCommand('copy'); copyPixButton.textContent = (translations[currentLang] || translations['pt']).pix_copied_button; setTimeout(() => { copyPixButton.textContent = (translations[currentLang] || translations['pt']).pix_copy_button; }, 2000); });
        
        window.addEventListener('load', () => {
            const userLang = (navigator.language || navigator.userLanguage).toLowerCase();
            const langCode = userLang.split('-')[0];
            currentLang = translations[langCode] ? langCode : 'en';
            
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                const dict = translations[currentLang] || translations['en'];
                if (dict[key]) {
                    element.textContent = dict[key];
                }
            });
            document.getElementById('price-display').textContent = (translations[currentLang] || translations['en']).price_display;
             document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-key-placeholder');
                 const dict = translations[currentLang] || translations['en'];
                 if (dict[key]) {
                    el.placeholder = dict[key];
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('session_id')) {
                grantAccessAndNotify(); 
            }
        });
    </script>
</body>
</html>
